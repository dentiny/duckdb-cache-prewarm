# name: test/sql/cache_prewarm.test
# description: test cache_prewarm extension
# group: [sql]

require cache_prewarm

# Load a persistent database file (not in-memory mode, otherwise all blocks won't be written to disk)
load __TEST_DIR__/cache_prewarm.db

statement ok
CREATE TABLE requests (
      id           INTEGER PRIMARY KEY,
      user_id      INTEGER NOT NULL,
      path         VARCHAR NOT NULL,
      status_code  INTEGER NOT NULL,
      duration_ms  INTEGER,
      created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

statement ok
INSERT INTO requests (id, user_id, path, status_code, duration_ms, created_at)
SELECT
    i + 5 AS id,
    (random() * 500)::INTEGER AS user_id,
    CASE
        WHEN random() < 0.5 THEN '/api/items'
        WHEN random() < 0.8 THEN '/api/items/' || (random() * 100)::INTEGER
        ELSE '/api/search?q=query'
    END AS path,
    (ARRAY[200, 201, 404, 500])[1 + (random() * 3)::INTEGER] AS status_code,
    (random() * 1000)::INTEGER AS duration_ms,
    '2024-12-01 10:05:00'::TIMESTAMP + INTERVAL (i) SECOND AS created_at
FROM range(1000000) t(i);

# Ensure the blocks are written to disk
statement ok
CHECKPOINT;

# Prewarm the duckdb cache for the requests table
query I
SELECT prewarm('requests');
----
24
