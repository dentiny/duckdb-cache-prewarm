# name: test/sql/cache_prewarm.test
# description: test cache_prewarm extension
# group: [sql]

require cache_prewarm

# Load a persistent database file (not in-memory mode, otherwise all blocks won't be written to disk)
load __TEST_DIR__/cache_prewarm.db

statement ok
CREATE TABLE requests (
      id           INTEGER PRIMARY KEY,
      user_id      INTEGER NOT NULL,
      path         VARCHAR NOT NULL,
      status_code  INTEGER NOT NULL,
      duration_ms  INTEGER,
      created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

statement ok
INSERT INTO requests (id, user_id, path, status_code, duration_ms, created_at)
SELECT
    i + 5 AS id,
    (random() * 500)::INTEGER AS user_id,
    CASE
        WHEN random() < 0.5 THEN '/api/items'
        WHEN random() < 0.8 THEN '/api/items/' || (random() * 100)::INTEGER
        ELSE '/api/search?q=query'
    END AS path,
    (ARRAY[200, 201, 404, 500])[1 + (random() * 3)::INTEGER] AS status_code,
    (random() * 1000)::INTEGER AS duration_ms,
    '2024-12-01 10:05:00'::TIMESTAMP + INTERVAL (i) SECOND AS created_at
FROM range(1000000) t(i);

restart

# Prewarm the duckdb cache for the requests table using default BUFFER mode
query I
SELECT prewarm('requests');
----
0

restart

# Test READ mode on the requests table
query I
SELECT prewarm('requests', 'read');
----
0

restart

# prefetch mode on the requests table
query I
SELECT prewarm('requests', 'prefetch') >= 24;
----
true

statement ok
CREATE TABLE events (
    event_id BIGINT,
    user_id INTEGER,
    session_id VARCHAR,
    event_type VARCHAR,
    event_data VARCHAR,
    timestamp TIMESTAMP,
    value DOUBLE
);

statement ok
INSERT INTO events
SELECT
    i AS event_id,
    (random() * 10000)::INTEGER AS user_id,
    'session_' || (random() * 5000)::INTEGER AS session_id,
    (ARRAY['click', 'view', 'purchase', 'signup', 'logout'])[1 + (random() * 4)::INTEGER] AS event_type,
    'data_' || (random() * 1000)::INTEGER AS event_data,
    '2024-01-01 00:00:00'::TIMESTAMP + INTERVAL (i) SECOND AS timestamp,
    random() * 1000 AS value
FROM range(500000) t(i);

restart

query I
SELECT prewarm('events') > 10;
----
true

restart

# After restart, read mode may or may not find blocks depending on partial block flush state
# The function should not error out even if partial blocks aren't fully flushed
query I
SELECT prewarm('events', 'read') >= 0;
----
true

restart

# prefetch mode on the events table
query I
SELECT prewarm('events', 'prefetch') >= 24;
----
true

