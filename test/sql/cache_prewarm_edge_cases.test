# name: test/sql/cache_prewarm_edge_cases.test
# description: Test prewarm with edge cases and various scenarios
# group: [sql]

require cache_prewarm

# Load a persistent database file
load __TEST_DIR__/cache_prewarm_edge_cases.db

# Test 1: Prewarm an empty table
statement ok
CREATE TABLE empty_table (id INTEGER, name VARCHAR);

statement ok
CHECKPOINT;

query I
SELECT prewarm('empty_table');
----
0

# Verify table is still accessible and empty
query I
SELECT COUNT(*) FROM empty_table;
----
0

# Test 2: Prewarm a table with a single row
statement ok
CREATE TABLE single_row (id INTEGER, value VARCHAR);

statement ok
INSERT INTO single_row VALUES (1, 'only_one');

statement ok
CHECKPOINT;

query I
SELECT prewarm('single_row');
----
1

query IT
SELECT * FROM single_row;
----
1	only_one

# Test 3: Prewarm a table with NULL values
statement ok
CREATE TABLE nulls_table (
    id INTEGER,
    nullable_int INTEGER,
    nullable_str VARCHAR,
    nullable_bool BOOLEAN
);

statement ok
INSERT INTO nulls_table VALUES
    (1, NULL, NULL, NULL),
    (2, 100, 'test', true),
    (3, NULL, 'partial', NULL),
    (4, 200, NULL, false);

statement ok
CHECKPOINT;

query I
SELECT prewarm('nulls_table') > 0;
----
true

# Verify NULLs are preserved
query IITT
SELECT * FROM nulls_table ORDER BY id;
----
1	NULL	NULL	NULL
2	100	test	true
3	NULL	partial	NULL
4	200	NULL	false

# Test 4: Prewarm a table with indexes
statement ok
CREATE TABLE indexed_table (
    id INTEGER PRIMARY KEY,
    name VARCHAR,
    value INTEGER
);

statement ok
INSERT INTO indexed_table
SELECT i, 'name_' || i, i * 10
FROM range(1000) t(i);

statement ok
CREATE INDEX idx_value ON indexed_table(value);

statement ok
CHECKPOINT;

query I
SELECT prewarm('indexed_table') > 0;
----
true

# Verify index still works correctly
query II
SELECT id, value FROM indexed_table WHERE value = 500;
----
50	500

# Test 5: Prewarm table with various data types
statement ok
CREATE TABLE all_types (
    id INTEGER,
    tiny_val TINYINT,
    small_val SMALLINT,
    int_val INTEGER,
    big_val BIGINT,
    float_val FLOAT,
    double_val DOUBLE,
    varchar_val VARCHAR,
    date_val DATE,
    time_val TIME,
    timestamp_val TIMESTAMP,
    bool_val BOOLEAN,
    blob_val BLOB
);

statement ok
INSERT INTO all_types VALUES (
    1,
    127,
    32000,
    2147483647,
    9223372036854775807,
    3.14,
    2.718281828,
    'test string',
    '2024-01-01',
    '12:34:56',
    '2024-01-01 12:34:56',
    true,
    '\xDE\xAD\xBE\xEF'::BLOB
);

statement ok
CHECKPOINT;

query I
SELECT prewarm('all_types');
----
1

# Verify all data types preserved
query IIIIIRRTTTTTT
SELECT * FROM all_types;
----
1	127	32000	2147483647	9223372036854775807	3.14	2.718281828	test string	2024-01-01	12:34:56	2024-01-01 12:34:56	true	\xDE\xAD\xBE\xEF

# Test 6: Prewarm after multiple checkpoints
statement ok
CREATE TABLE multi_checkpoint (id INTEGER, batch INTEGER);

statement ok
INSERT INTO multi_checkpoint SELECT i, 1 FROM range(100) t(i);

statement ok
CHECKPOINT;

statement ok
INSERT INTO multi_checkpoint SELECT i, 2 FROM range(100, 200) t(i);

statement ok
CHECKPOINT;

statement ok
INSERT INTO multi_checkpoint SELECT i, 3 FROM range(200, 300) t(i);

statement ok
CHECKPOINT;

query I
SELECT prewarm('multi_checkpoint') > 0;
----
true

# Verify all batches are present
query II
SELECT batch, COUNT(*) FROM multi_checkpoint GROUP BY batch ORDER BY batch;
----
1	100
2	100
3	100

# Test 7: Prewarm table with string data of varying lengths
statement ok
CREATE TABLE string_lengths (
    id INTEGER,
    short_str VARCHAR,
    long_str VARCHAR
);

statement ok
INSERT INTO string_lengths VALUES
    (1, 'a', repeat('x', 100)),
    (2, 'ab', repeat('y', 1000)),
    (3, 'abc', repeat('z', 10000));

statement ok
CHECKPOINT;

query I
SELECT prewarm('string_lengths') > 0;
----
true

# Verify string lengths preserved
query III
SELECT id, length(short_str), length(long_str) FROM string_lengths ORDER BY id;
----
1	1	100
2	2	1000
3	3	10000

# Test 8: Prewarm the same table multiple times (idempotency)
statement ok
CREATE TABLE idempotent_test (id INTEGER, value VARCHAR);

statement ok
INSERT INTO idempotent_test VALUES (1, 'test');

statement ok
CHECKPOINT;

# First prewarm
query I
SELECT prewarm('idempotent_test');
----
1

# Second prewarm - should still work
query I
SELECT prewarm('idempotent_test');
----
1

# Third prewarm
query I
SELECT prewarm('idempotent_test');
----
1

# Data should still be correct
query IT
SELECT * FROM idempotent_test;
----
1	test

# Test 9: Prewarm table with transactions
statement ok
CREATE TABLE transaction_test (id INTEGER, value INTEGER);

statement ok
BEGIN TRANSACTION;

statement ok
INSERT INTO transaction_test SELECT i, i * 100 FROM range(1000) t(i);

statement ok
COMMIT;

statement ok
CHECKPOINT;

query I
SELECT prewarm('transaction_test') > 0;
----
true

query I
SELECT COUNT(*) FROM transaction_test;
----
1000

query II
SELECT * FROM transaction_test WHERE id IN (0, 500, 999) ORDER BY id;
----
0	0
500	50000
999	99900

# Test 10: Table name case sensitivity
statement ok
CREATE TABLE "MixedCase" (id INTEGER, value VARCHAR);

statement ok
INSERT INTO "MixedCase" VALUES (1, 'test');

statement ok
CHECKPOINT;

query I
SELECT prewarm('MixedCase');
----
1

query IT
SELECT * FROM "MixedCase";
----
1	test

# Test 11: Prewarm a table where all column data is constant block (no data blocks allocated) should return 0
# https://github.com/duckdb/duckdb/blob/d1dc88f950d456d72493df452dabdcd13aa413dd/src/storage/table/column_checkpoint_state.cpp#L136-L139
# https://github.com/duckdb/duckdb/blob/d1dc88f950d456d72493df452dabdcd13aa413dd/src/storage/table/column_segment.cpp#L240-L248
statement ok
CREATE TABLE small_table (id INTEGER, balance DECIMAL(18, 2));

statement ok
INSERT INTO small_table VALUES (1, 100.00);

statement ok
CHECKPOINT;

query I
SELECT prewarm('small_table');
----
0
